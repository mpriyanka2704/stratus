!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.utility"],e):e(t.Stratus,t._,t.angular)}(this,function(t,e,i){t.Services.Model=["$provide",function(n){n.factory("Model",["$q","$http","$mdToast","$rootScope","$log","utility",function(n,s,r,a,o,c){return function(h,u){this.target=null,this.manifest=!1,this.stagger=!1,this.toast=!1,this.urlRoot="/Api",h&&"object"==typeof h||(h={}),i.extend(this,h),this.identifier=null,this.data={},this.header=new t.Prototypes.Model,this.meta=new t.Prototypes.Model,e.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),u&&"object"==typeof u&&i.extend(this.data,u),this.target&&(this.urlRoot+="/"+e.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changed=!1,this.saving=!1,this.watching=!1,this.patch={};const l=this;this.watcher=function(){if(l.watching)return!0;l.watching=!0,a.$watch(function(){return l.data},function(i,n){const s=e.patch(i,n);t.Environment.get("production")||o.log("Patch:",s),s&&(l.changed=!0,(i.id&&i.id!==n.id||l.isNewVersion(i))&&window.location.replace(t.Internals.SetUrlParams({id:i.id})),l.patch=e.extend(l.patch,s))},!0)},this.getIdentifier=function(){return this.identifier=l.get("id")||l.identifier},this.getType=function(){return this.type=l.type||l.target||"orphan"},this.getHash=function(){return this.getType()+(e.isNumber(this.getIdentifier())?this.getIdentifier().toString():this.getIdentifier())},this.url=function(){let t=l.getIdentifier()?l.urlRoot+"/"+l.getIdentifier():l.urlRoot+(l.targetSuffix||"");return e.getUrlParams("version")&&(t+=t.includes("?")?"&":"?",t+="options[version]="+e.getUrlParams("version")),t},this.serialize=function(t,e){const n=[];return t=t||{},i.forEach(t,function(t,s){if(i.isObject(t))e&&(s=e+"["+s+"]"),n.push(l.serialize(t,s));else{let i="";e&&(i+=e+"["),i+=s,e&&(i+="]"),n.push(i+"="+t)}}),n.join("&")},this.sync=function(r,a,c){return this.pending=!0,n(function(n,h){c=c||{};const u={method:r=r||"GET",url:l.url(),headers:{}};i.isDefined(a)&&("GET"===r?i.isObject(a)&&Object.keys(a).length&&(u.url.includes("?")?u.url+="&":u.url+="?",u.url+=l.serialize(a)):(u.headers["Content-Type"]="application/json",u.data=JSON.stringify(a))),t.Environment.get("production")||o.log("Prototype:",u),c.hasOwnProperty("headers")&&"object"==typeof c.headers&&Object.keys(c.headers).forEach(function(t){u.headers[t]=c.headers[t]}),s(u).then(function(t){if(200===t.status&&i.isObject(t.data)){l.header.set(t.headers()||{}),l.meta.set(t.data.meta||{});const s=t.data.payload||t.data;l.meta.has("status")&&"SUCCESS"!==e.first(l.meta.get("status")).code?l.error=!0:i.isArray(s)&&s.length?(l.data=e.first(s),l.error=!1):i.isObject(s)&&!i.isArray(s)?(l.data=s,l.error=!1):l.error=!0,l.error||(l.completed=!0,l.saving=!1,l.patch={},l.watcher(),setTimeout(function(){l.changed=!1},100)),l.pending=!1,n(l.data)}else l.pending=!1,l.error=!0,h(t.statusText&&"OK"!==t.statusText?t.statusText:i.isObject(t.data)?t.data:"Invalid Payload: "+u.method+" "+u.url,t)}).catch(function(){h("XHR: "+u.method+" "+u.url)})})},this.fetch=function(t,e,i){return l.sync(t,e||l.meta.get("api"),i).catch(function(t){l.toast&&r.show(r.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),o.error("FETCH:",t)})},this.save=function(){return l.saving=!0,l.sync(l.getIdentifier()?"PUT":"POST",l.toJSON({patch:!0})).catch(function(t){l.toast&&r.show(r.simple().textContent("Failure to Save!").toastClass("errorMessage").position("top right").hideDelay(3e3)),o.error("SAVE:",t)})},this.specialAction=function(t){this.meta.temp("api.options.apiSpecialAction",t),this.save(),this.meta.get("api")&&this.meta.get("api").hasOwnProperty("options")&&this.meta.get("api").options.hasOwnProperty("apiSpecialAction")&&delete this.meta.get("api").options.apiSpecialAction},this.throttle=e.throttle(this.save,2e3),this.throttleSave=function(){return n(function(t,e){const i=l.throttle();o.log("throttle request:",i),i.then(function(e){o.log("throttle received:",e),t(e)}).catch(e)})},this.toJSON=function(t){let e;return e=l.data,e=l.meta.has("api")?{meta:l.meta.get("api"),payload:e}:e,l.meta.size()>0&&l.meta.clearTemp(),e},l.toPatch=function(){return l.patch},this.bracket={match:/\[[\d+]]/,search:/\[([\d+])]/g,attr:/(^[^[]+)/},this.buildPath=function(t){const i=[];if(!e.isString(t))return i;let n,s;return e.each(t.split("."),function(t){if(t.match(l.bracket.match))for(null!==(n=l.bracket.attr.exec(t))?(i.push(n[1]),n=null):n=!1,s=l.bracket.search.exec(t);null!==s;)!1!==n&&(n=parseInt(s[1]),isNaN(n)?n=!1:i.push(n)),s=l.bracket.search.exec(t);else i.push(t)}),i},this.get=function(t){return"string"==typeof t&&l.data&&"object"==typeof l.data?l.buildPath(t).reduce(function(t,e){return t&&t[e]},l.data):void 0},this.find=function(t,e,i){return"string"==typeof t&&(t=l.get(t)),t instanceof Array?t.find(function(t){return t[e]===i}):t},this.isNewVersion=function(t){return!e.isEmpty(c.moreParams())&&t.version&&parseInt(c.moreParams().version)!==t.version.id},this.set=function(t,i){t&&"object"==typeof t?e.each(t,function(t,e){l.setAttribute(e,t)},this):l.setAttribute(t,i)},this.setAttribute=function(t,i){if("string"==typeof t&&(e.contains(t,".")||e.contains(t,"["))){let n;l.buildPath(t).reduce(function(t,s,r,a){return n=r+1,e.has(t,s)||(t[s]=e.has(a,n)&&e.isNumber(a[n])?[]:{}),e.has(a,n)||(t[s]=i),t&&t[s]},l.data)}else l.data[t]=i},this.toggle=function(t,n,s){i.isObject(s)&&i.isDefined(s.multiple)&&i.isUndefined(s.strict)&&(s.strict=!0),s=e.extend({multiple:!0},i.isObject(s)?s:{});const r=t.split("[].");let a=l.get(r.length>1?r[0]:t);return(i.isUndefined(a)||s.strict&&i.isArray(a)!==s.multiple)&&(a=s.multiple?[]:null,l.set(r.length>1?r[0]:t,a)),i.isArray(a)?i.isUndefined(n)?l.set(t,null):l.exists(t,n)?e.each(a,function(t,s){const o=r.length>1&&i.isObject(t)&&r[1]in t?t[r[1]]:t,c=i.isObject(o)&&o.id?o.id:o,h=i.isObject(n)&&n.id?n.id:n;(c===h||i.isString(c)&&i.isString(h)&&0===e.strcmp(c,h))&&a.splice(s,1)}):a.push(n):"object"==typeof a||"number"==typeof a?l.set(t,l.exists(t,n)?null:n):i.isUndefined(n)&&l.set(t,!a),l.get(t)},this.pluck=function(t){if(!("string"==typeof t&&t.indexOf("[].")>-1))return l.get(t);{const e=t.split("[].");if(e.length>1&&(t=l.get(e[0]))&&i.isArray(t)){const n=[];if(t.forEach(function(t){i.isObject(t)&&e[1]in t&&n.push(t[e[1]])}),n.length)return n}}},this.exists=function(t,n){return n?!("string"!=typeof t||!n)&&(t=l.pluck(t),i.isArray(t)?void 0!==t.find(function(t){return t===n||i.isObject(t)&&t.id&&t.id===n||e.isEqual(t,n)}):t===n||i.isObject(t)&&t.id&&(e.isEqual(t,n)||t.id===n)):void 0!==(t=l.get(t))&&t},this.destroy=function(){l.collection&&l.collection.remove(l),l.getIdentifier()&&l.sync("DELETE",{}).catch(function(t){l.toast&&r.show(r.simple().textContent("Failure to Delete!").toastClass("errorMessage").position("top right").hideDelay(3e3)),o.error("DESTROY:",t)})},this.initialize=e.once(this.initialize||function(){l.manifest&&!l.getIdentifier()&&l.sync("POST",l.meta.has("api")?{meta:l.meta.get("api"),payload:{}}:{}).catch(function(t){l.toast&&r.show(r.simple().textContent("Failure to Manifest!").toastClass("errorMessage").position("top right").hideDelay(3e3)),o.error("MANIFEST:",t)})}),l.stagger||this.initialize()}}])}]});